<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestbenchPLC - Editor</title>
    <link rel="icon shortcut" type="image/x-icon" href="./favicon.ico">
    <script src="./scripts/blockly_compressed.js"></script>
    <script src="./scripts/blocks_compressed.js"></script>
    <script src="./scripts/javascript_compressed.js"></script>
    <script src="./scripts/zh-hans.js"></script>
    <meta name="description" content="TestbenchPLC Editor">
    <!-- Material Design Icons CDN -->
    <link rel="stylesheet" href="./materialicon/materialdesignicons.min.css">
    <style>
        html {
            height: 100%;
            overflow: hidden;
        }

        .notice {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
        }

        /* 加载遮罩样式 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 30, 30, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #d4d4d4;
            font-size: 16px;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: auto;
            overscroll-behavior: none;
            scrollbar-color: transparent transparent;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            height: 56px;
            background: #1976d2;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* toolbox 样式 */
        #toolbox {
            position: relative;
            width: 260px;
            min-width: 60px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.04);
            transition: width 0.3s;
            z-index: 2;
            height: 100%;
            overflow: auto;
        }

        #toolbox.collapsed {
            width: 0px;
            min-width: 0px;
        }

        #toolbox-toggle {
            display: none;
            position: absolute;
            top: 32px;
            left: 260px;
            /* toolbox宽度 */
            width: 32px;
            height: 32px;
            /* 改短按钮高度 */
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            z-index: 10;
            font-size: 1.5em;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.08);
            transition: left 0.3s;
        }

        #toolbox.collapsed~#toolbox-toggle {
            left: 0;
        }

        #toolbox-toggle span {
            margin-left: 2px;
        }

        @media (max-width: 900px),
        (orientation: portrait) {
            #toolbox.collapsed {
                width: 0;
                min-width: 0;
            }

            #toolbox-toggle {
                display: block;
            }
        }

        .toolbar-left {
            font-size: 1.2em;
            font-weight: bold;
        }

        .toolbar-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .toolbar-center select {
            padding: 6px 12px;
            font-size: 1em;
            border-radius: 4px;
            border: none;
            min-width: max-content;
            width: 33vw;
            max-width: 100%;
            box-sizing: border-box;
        }

        .toolbar-right {
            display: flex;
            gap: 8px;
        }

        .toolbar-right button {
            background: #fff;
            color: #1976d2;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 1.3em;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-right button:hover {
            background: #e3f2fd;
        }

        .main-content {
            flex: 1;
            width: 100%;
            background: #f5f5f5;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            justify-content: flex-start;
            position: relative;
        }

        @media (max-width: 600px) {
            .toolbar {
                flex-direction: column;
                height: auto;
                padding: 8px;
            }

            .toolbar-center {
                margin: 8px 0;
            }

            .toolbar-right {
                justify-content: center;
            }

            .toolbar-left {
                display: none !important;
            }
        }

        #orientation-tip {
            display: none;
            background: #ffc107;
            color: #333;
            text-align: center;
            padding: 8px;
            font-size: 1em;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .program-input {
            padding: 6px 12px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #1976d2;
            width: calc(100% - 24px);
            box-sizing: border-box;
            margin: 0 12px;
        }

        .program-input.error {
            border-color: #ff1100;
            background-color: #ff657d;
        }

        .program-select-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <!-- 加载遮罩 -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">正在加载编辑器...</div>
    </div>

    <div class="notice" id="captiveNotice" style="display: none;">
        编辑器受限，为了获取更好的体验，请
        <a class="btn"
            href="intent://192.168.45.1/editor.html#Intent;scheme=http;action=android.intent.action.VIEW;category=android.intent.category.BROWSABLE;end">
            在浏览器中打开
        </a>
    </div>


    <div class="toolbar">
        <div class="toolbar-left">TestbenchPLC 流程编辑器</div>
        <div class="toolbar-center">
            <select id="programSelect">
                <option value="default">default</option>
                <option value="new">新建...</option>
            </select>
        </div>
        <div class="toolbar-right">
            <button title="删除" onclick="DeleteProgram();"><span class="mdi mdi-delete"></span></button>
            <button title="保存" onclick="Save();"><span class="mdi mdi-content-save"></span></button>
            <button title="导出" onclick="Download();"><span class="mdi mdi-file-export"></span></button>
            <button title="导入" onclick="Import();"><span class="mdi mdi-file-upload"></span></button>
            <!--button title="运行" onclick="RunProgram();"><span class="mdi mdi-play-circle"></span></button-->
        </div>
    </div>
    <div class="main-content" id="mainContent">
        <div id="blocklyDiv" style="position: absolute"></div>
    </div>
    <script type="text/javascript">
        var programSelect = document.getElementById('programSelect');

        const FSD_SETFREQ = {
            init: function () {
                this.appendValueInput('NAME')
                    .setCheck('Number')
                    .appendField('将变频器')
                    .appendField(new Blockly.FieldNumber(1, 0, 255, 1), 'ID')
                    .appendField('频率设置为');
                this.appendDummyInput('NAME')
                    .appendField('Hz');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(195);
            }
        };
        const EVENT_DI = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField('当输入')
                    .appendField(new Blockly.FieldDropdown([
                        ['DI1', 'DI1'],
                        ['DI2', 'DI2'],
                        ['DI3', 'DI3'],
                        ['DI4', 'DI4']
                    ]), 'pin')
                    .appendField(new Blockly.FieldDropdown([
                        ['变为有效', 'RISE'],
                        ['变为无效', 'FALL'],
                        ['发生改变', 'CHANGE']
                    ]), 'edge');
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(285);
            }
        };
        const EVENT_PWRON = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField('当程序开始运行');
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(285);
            }
        };
        const FSD_RUNSTOP = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField('控制变频器')
                    .appendField(new Blockly.FieldNumber(1, 0, 255, 1), 'ID')
                    .appendField(new Blockly.FieldDropdown([
                        ['开始运行', 'RUN'],
                        ['刹车停止', 'STOP'],
                        ['停机空转', 'FREESTOP']
                    ]), 'command');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(195);
            }
        };
        const FSD_RISEFALLTIME = {
            init: function () {
                this.appendValueInput('speed')
                    .appendField('变频器')
                    .appendField(new Blockly.FieldNumber(1, 0, 255, 1), 'ID')
                    .appendField(new Blockly.FieldDropdown([
                        ['加速', 'rise'],
                        ['减速', 'fall']
                    ]), 'risefall')
                    .appendField('时间设置为');
                this.appendDummyInput('NAME')
                    .appendField('秒');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(195);
            }
        };
        const EVENT_FSD = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField('当变频器')
                    .appendField(new Blockly.FieldNumber(1, 0, 255, 1), 'ID')
                    .appendField(new Blockly.FieldDropdown([
                        ['加速完成', 'rised'],
                        ['减速完成', 'falled'],
                        ['出现故障', 'fault']
                    ]), 'trigger');
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(285);
            }
        };
        const FSD_GETVALUE = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField('变频器')
                    .appendField(new Blockly.FieldNumber(1, 0, 255, 1), 'ID')
                    .appendField('的')
                    .appendField(new Blockly.FieldDropdown([
                        ['实时频率', 'freq'],
                        ['母线电压', 'volt'],
                        ['输出电流', 'curr'],
                        ['模块温度', 'temp']
                    ]), 'aa');
                this.setOutput(true, 'Number');
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(195);
            }
        };
        const REG_GET = {
            init: function () {
                this.appendValueInput('ADDR')
                    .setCheck('Number')
                    .appendField('寄存器');
                this.appendDummyInput('NAME')
                    .appendField('的值');;
                this.setOutput(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(330);
            }
        };
        const REG_SET = {
            init: function () {
                this.appendValueInput('ADDR')
                    .setCheck('Number')
                    .appendField('写寄存器');
                this.appendValueInput('VALUE')
                    .setCheck('Number')
                    .appendField('为');
                this.appendDummyInput('NAME');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(330);
            }
        };
        const DI_IN = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField(new Blockly.FieldDropdown([
                        ['DI1', 'DI1'],
                        ['DI2', 'DI2'],
                        ['DI3', 'DI3'],
                        ['DI4', 'DI4']
                    ]), 'ID');
                this.setOutput(true, 'Number');
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(0);
            }
        };
        const AI_IN = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField(new Blockly.FieldDropdown([
                        ['AI1', 'AI1'],
                        ['AI2', 'AI2']
                    ]), 'ID')
                    .appendField('mV');
                this.setOutput(true, 'Number');
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(0);
            }
        };
        const IO_OUT = {
            init: function () {
                this.appendDummyInput('NAME')
                    .appendField(new Blockly.FieldDropdown([
                        ['DO1', 'DO1'],
                        ['DO2', 'DO2'],
                        ['DO3', 'DO3'],
                        ['DO4', 'DO4']
                    ]), 'ID')
                    .appendField('设为');
                this.appendValueInput('VALUE')
                    .setCheck('Number');
                this.appendEndRowInput('NAME');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(0);
            }
        };
        const CTRL_DELAY = {
            init: function () {
                this.appendValueInput('NAME')
                    .setCheck('Number')
                    .appendField('等待');
                this.appendEndRowInput('VALUE')
                    .appendField('ms');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(210);
            }
        };
        const MODBUS_WRITE = {
            init: function () {
                this.appendValueInput('VALUE')
                    .setCheck('Number')
                    .appendField('向通讯接口')
                    .appendField(new Blockly.FieldDropdown([
                        ['1', '1'],
                        ['2', '2']
                    ]), 'ID')
                    .appendField('从机');
                this.appendValueInput('SLAVE')
                    .setCheck('Number')
                    .appendField('地址');
                this.appendValueInput('ADDR')
                    .setCheck('Number')
                    .appendField('写')
                    .appendField(new Blockly.FieldDropdown([
                        ['线圈(05)', '5'],
                        ['寄存器(06)', '6']
                    ]), 'type')
                    .appendField('为');
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(0);
            }
        };
        const MODBUS_READ = {
            init: function () {
                this.appendValueInput('VALUE')
                    .setCheck('Number')
                    .appendField('读通讯接口')
                    .appendField(new Blockly.FieldDropdown([
                        ['1', '1'],
                        ['2', '2']
                    ]), 'ID')
                    .appendField('从机');
                this.appendValueInput('SLAVE')
                    .setCheck('Number')
                    .appendField('读取')
                    .appendField(new Blockly.FieldDropdown([
                        ['线圈(01)', '1'],
                        ['寄存器(04)', '4']
                    ]), 'ID')
                    .appendField('地址');
                this.setOutput(true, null);
                this.setTooltip('');
                this.setHelpUrl('');
                this.setColour(0);
            }
        };
        Blockly.common.defineBlocks({ FSD_SETFREQ: FSD_SETFREQ });
        Blockly.common.defineBlocks({ EVENT_DI: EVENT_DI });
        Blockly.common.defineBlocks({ EVENT_PWRON: EVENT_PWRON });
        Blockly.common.defineBlocks({ FSD_RUNSTOP: FSD_RUNSTOP });
        Blockly.common.defineBlocks({ FSD_RISEFALLTIME: FSD_RISEFALLTIME });
        Blockly.common.defineBlocks({ EVENT_FSD: EVENT_FSD });
        Blockly.common.defineBlocks({ FSD_GETVALUE: FSD_GETVALUE });
        Blockly.common.defineBlocks({ REG_GET: REG_GET });
        Blockly.common.defineBlocks({ REG_SET: REG_SET });
        Blockly.common.defineBlocks({ DI_IN: DI_IN });
        Blockly.common.defineBlocks({ AI_IN: AI_IN });
        Blockly.common.defineBlocks({ IO_OUT: IO_OUT });
        Blockly.common.defineBlocks({ CTRL_DELAY: CTRL_DELAY });
        Blockly.common.defineBlocks({ MODBUS_WRITE: MODBUS_WRITE });
        Blockly.common.defineBlocks({ MODBUS_READ: MODBUS_READ });

        var toolbox = {
            "kind": "categoryToolbox",
            "contents": [
                {
                    "kind": "category",
                    "name": "入口",
                    "colour": "285",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "EVENT_PWRON"
                        },
                        {
                            "kind": "block",
                            "type": "EVENT_DI"
                        },
                        {
                            "kind": "block",
                            "type": "EVENT_FSD"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "分支",
                    "colour": "210",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "controls_if"
                        },
                        {
                            "kind": "block",
                            "type": "logic_compare"
                        },
                        {
                            "kind": "block",
                            "type": "logic_operation"
                        },
                        {
                            "kind": "block",
                            "type": "logic_negate"
                        },
                        {
                            "kind": "block",
                            "type": "logic_boolean"
                        },
                        {
                            "kind": "block",
                            "type": "CTRL_DELAY"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "循环",
                    "colour": "120",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "controls_whileUntil"
                        },
                        {
                            "kind": "block",
                            "type": "controls_repeat_ext"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "数学",
                    "colour": "225",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "math_number"
                        },
                        {
                            "kind": "block",
                            "type": "math_arithmetic"
                        },
                        {
                            "kind": "block",
                            "type": "math_single"
                        },
                        {
                            "kind": "block",
                            "type": "math_trig"
                        },
                        {
                            "kind": "block",
                            "type": "math_constant"
                        },
                        {
                            "kind": "block",
                            "type": "math_number_property"
                        },
                        {
                            "kind": "block",
                            "type": "math_round"
                        },
                        {
                            "kind": "block",
                            "type": "math_modulo"
                        },
                        {
                            "kind": "block",
                            "type": "math_random_int"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "存取",
                    "colour": "330",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "REG_GET"
                        },
                        {
                            "kind": "block",
                            "type": "REG_SET"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "IO",
                    "colour": "0",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "DI_IN"
                        },
                        {
                            "kind": "block",
                            "type": "AI_IN"
                        },
                        {
                            "kind": "block",
                            "type": "IO_OUT"
                        },
                        {
                            "kind": "block",
                            "type": "MODBUS_READ"
                        },
                        {
                            "kind": "block",
                            "type": "MODBUS_WRITE"
                        }
                    ]
                },
                {
                    "kind": "category",
                    "name": "变频",
                    "colour": "195",
                    "contents": [
                        {
                            "kind": "block",
                            "type": "FSD_GETVALUE"
                        },
                        {
                            "kind": "block",
                            "type": "FSD_RISEFALLTIME"
                        },
                        {
                            "kind": "block",
                            "type": "FSD_RUNSTOP"
                        },
                        {
                            "kind": "block",
                            "type": "FSD_SETFREQ"
                        }
                    ]
                }
            ]
        };
    </script>
    <script type="text/javascript">
        window.addEventListener('DOMContentLoaded', function () {
            // 当选择程序时加载程序内容
            programSelect.addEventListener('change', function (e) {
                // 如果选择的是"新建..."，则不执行加载操作
                if (e.target.value === 'new') {
                    return;
                }

                // 获取选中的程序名称
                const selectedProgram = e.target.value;

                // 创建GET请求
                const xhr = new XMLHttpRequest();
                xhr.open('GET', './api/progload?name=' + encodeURIComponent(selectedProgram), true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                // 设置请求完成后的回调函数
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                // 解析JSON内容
                                const content = JSON.parse(xhr.responseText);
                                // 将内容加载到工作区
                                Blockly.serialization.workspaces.load(content, Blockly.getMainWorkspace());
                            } catch (error) {
                                console.error('程序加载失败:', error);
                            }
                        } else {
                            console.error('加载程序失败，状态码:', xhr.status);
                        }
                    }
                };
                // 发送请求
                xhr.send();
                // 清空工作区
                const workspace = Blockly.getMainWorkspace();
                workspace.clear();
            });

            const blocklyArea = document.getElementById('mainContent');
            const blocklyDiv = document.getElementById('blocklyDiv');
            const workspace = Blockly.inject(blocklyDiv, {
                toolbox: toolbox,
                sounds: false,
                renderer: 'thrasos',
                scrollbars: true,
                zoom:
                {
                    controls: false,
                    wheel: true,
                    startScale: 0.7,
                    maxScale: 1,
                    minScale: 0.3,
                    scaleSpeed: 1.2,
                    pinch: true
                },
            });

            // blocklyDiv 尺寸调整
            const onresize = function (e) {
                var eelement = blocklyArea;
                let x = 0;
                let y = 0;
                blocklyDiv.style.left = x + 'px';
                blocklyDiv.style.top = y + 'px';
                blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
                blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
                Blockly.svgResize(workspace);
            };
            window.addEventListener('resize', onresize, false);
            onresize();

            // 屏幕方向提示
            function showOrientationTipIfNeeded() {
                const tip = document.getElementById('orientation-tip');
                // 判断是否为移动设备
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                // 判断是否为竖屏
                const isPortrait = window.innerHeight > window.innerWidth;
                if (isMobile && isPortrait) {
                    tip.style.display = 'block';
                } else {
                    tip.style.display = 'none';
                }
            }

            // 加载程序列表
            fetch('./api/proglist')
                .then(response => response.json())
                .then(programs => {
                    // 为每个程序创建选项并添加到选择框
                    programs.forEach(program => {
                        const option = document.createElement('option');
                        option.value = program;
                        option.textContent = program;
                        // 在"新建..."选项之前插入
                        programSelect.insertBefore(option, programSelect.lastElementChild);
                    });
                })
                .catch(error => {
                    console.error('加载程序列表失败:', error);
                });
        });
    </script>
    <script type="text/javascript">
        function Download() {
            if (programSelect.value == 'new') return;
            var wbjson = Blockly.serialization.workspaces.save(Blockly.getMainWorkspace());
            var filename = programSelect.value + '.tbp';
            var downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(new Blob([JSON.stringify(wbjson, null, 1)], { type: 'application/json' }));
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        function Save() {
            var programSelect = document.getElementById('programSelect');
            var selectedProgram = programSelect.value;
            var saveButton = document.querySelector('.toolbar-right button:nth-child(2)');

            // 如果选择的是"新建..."，则提示用户先选择一个程序
            if (selectedProgram === 'new') {
                showSaveResult(saveButton, false);
                return;
            }

            var wbjson = Blockly.serialization.workspaces.save(Blockly.getMainWorkspace());

            // 创建POST请求
            var xhr = new XMLHttpRequest();
            xhr.open('POST', './api/save?name=' + (selectedProgram), true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            // 设置请求完成后的回调函数
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    // 显示保存结果
                    showSaveResult(saveButton, xhr.status === 200);
                }
            };

            // 发送请求
            xhr.send(JSON.stringify(wbjson));
        }

        function showSaveResult(button, isSuccess) {
            // 保存原始内容
            var originalContent = button.innerHTML;

            // 创建淡出效果
            button.style.transition = 'opacity 0.3s';
            button.style.opacity = '0.5';

            setTimeout(function () {
                // 更改图标
                if (isSuccess) {
                    button.innerHTML = '<span class="mdi mdi-check"></span>';
                } else {
                    button.innerHTML = '<span class="mdi mdi-close"></span>';
                }

                // 恢复透明度
                button.style.opacity = '1';

                // 2秒后恢复原始内容
                setTimeout(function () {
                    button.style.transition = 'opacity 0.3s';
                    button.style.opacity = '0.5';

                    setTimeout(function () {
                        button.innerHTML = originalContent;
                        button.style.opacity = '1';
                    }, 300);
                }, 2000);
            }, 300);
        }

        function DeleteProgram() {
            const programSelect = document.getElementById('programSelect');
            const selectedProgram = programSelect.value;

            // 不能删除default程序
            if (selectedProgram === 'default') {
                alert('不能删除default程序');
                return;
            }

            // 确认删除
            if (!confirm('确定要删除程序 "' + selectedProgram + '" 吗？')) {
                return;
            }

            // 调用API删除程序
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/progdel?name=' + encodeURIComponent(selectedProgram), true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // 删除成功，从下拉列表中移除该选项
                        const optionToRemove = Array.from(programSelect.options).find(opt => opt.value === selectedProgram);
                        if (optionToRemove) {
                            programSelect.removeChild(optionToRemove);
                        }

                        // 选中default
                        programSelect.value = 'default';


                        // 清空工作区
                        const workspace = Blockly.getMainWorkspace();
                        workspace.clear();
                    } else {
                        // 删除失败
                        alert('删除程序失败: ' + (xhr.responseText || 'API操作发生未知错误'));
                    }
                }
            };

            // 发送请求
            xhr.send();
        }

        function Import() {
            // 创建文件选择元素
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.tbp'; // 只接受.tbp文件

            // 添加文件选择事件监听
            input.addEventListener('change', function (e) {
                var file = e.target.files[0];
                if (!file) return;

                // 检查文件类型
                if (!file.name.endsWith('.tbp')) {
                    alert('仅支持导入.tbp文件');
                    return;
                }

                // 读取文件内容
                var reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        // 解析JSON内容
                        var content = JSON.parse(event.target.result);
                        // 将内容加载到工作区
                        Blockly.serialization.workspaces.load(content, Blockly.getMainWorkspace());

                        // 获取文件名（不含扩展名）
                        var filename = file.name.replace(/\.tbp$/, '');

                        // 检查是否已存在同名程序
                        var programSelect = document.getElementById('programSelect');
                        var existingOptions = Array.from(programSelect.options).filter(opt => opt.value !== 'new' && opt.value === filename);

                        // 如果不存在同名程序，则添加新选项
                        if (existingOptions.length === 0) {
                            var option = document.createElement('option');
                            option.value = filename;
                            option.textContent = filename;
                            programSelect.insertBefore(option, programSelect.lastElementChild);
                        }

                        // 选中该程序
                        programSelect.value = filename;

                        // 触发保存操作
                        Save();
                    } catch (error) {
                        alert('文件解析失败: ' + error.message);
                    }
                };

                reader.onerror = function () {
                    alert('文件读取失败');
                };

                reader.readAsText(file);
            });

            // 触发文件选择对话框
            input.click();
        }
        document.addEventListener('DOMContentLoaded', function () {
            const programSelect = document.getElementById('programSelect');
            const newOption = programSelect.querySelector('option[value="new"]');
            let inputBox = null;

            // 检查是否只有新建选项
            const hasOnlyNewOption = programSelect.options.length === 1 &&
                programSelect.options[0].value === 'new';

            // 如果只有新建选项，直接显示文本框
            if (hasOnlyNewOption) {
                // 隐藏原来的select
                programSelect.style.display = 'none';

                // 创建容器
                const wrapper = document.createElement('div');
                wrapper.className = 'program-select-wrapper';
                programSelect.parentNode.insertBefore(wrapper, programSelect);

                // 创建输入框
                inputBox = document.createElement('input');
                inputBox.type = 'text';
                inputBox.className = 'program-input';
                inputBox.placeholder = '输入程序名称';
                wrapper.appendChild(inputBox);

                // 自动聚焦
                inputBox.focus();
                inputBox.select();

                // 添加回车键监听
                inputBox.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                        createNewProgram(inputBox.value, wrapper, programSelect);
                    } else if (event.key === 'Escape') {
                        // 取消创建
                        cancelNewProgram(wrapper, programSelect);
                    }
                });

                // 添加失焦监听
                inputBox.addEventListener('blur', function () {
                    createNewProgram(inputBox.value, wrapper, programSelect);
                });

                // 添加输入验证
                inputBox.addEventListener('input', function () {
                    // 移除可能存在的错误提示
                    const errorMsg = wrapper.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }

                    // 只允许大小写字母、数字和下划线
                    const isValid = /^[a-zA-Z0-9_]*$/.test(inputBox.value);
                    if (!isValid && inputBox.value !== '') {
                        inputBox.classList.add('error');
                    } else {
                        inputBox.classList.remove('error');

                        // 检查是否重名
                        if (inputBox.value !== '') {
                            const existingOptions = Array.from(programSelect.options).filter(opt => opt.value !== 'new' && opt.value === inputBox.value);
                            if (existingOptions.length > 0) {
                                inputBox.classList.add('error');
                            }
                        }
                    }
                });
            } //else
            {
                // 当选择"新建..."时显示输入框
                programSelect.addEventListener('change', function (e) {
                    if (e.target.value === 'new') {
                        // 隐藏原来的select
                        programSelect.style.display = 'none';

                        // 创建容器
                        const wrapper = document.createElement('div');
                        wrapper.className = 'program-select-wrapper';
                        programSelect.parentNode.insertBefore(wrapper, programSelect);

                        // 创建输入框
                        inputBox = document.createElement('input');
                        inputBox.type = 'text';
                        inputBox.className = 'program-input';
                        inputBox.placeholder = '输入程序名称';
                        wrapper.appendChild(inputBox);

                        // 自动聚焦
                        inputBox.focus();
                        inputBox.select();

                        // 添加回车键监听
                        inputBox.addEventListener('keydown', function (event) {
                            if (event.key === 'Enter') {
                                createNewProgram(inputBox.value, wrapper, programSelect);
                            } else if (event.key === 'Escape') {
                                // 取消创建
                                cancelNewProgram(wrapper, programSelect);
                            }
                        });

                        // 添加失焦监听
                        inputBox.addEventListener('blur', function () {
                            createNewProgram(inputBox.value, wrapper, programSelect);
                        });

                        // 添加输入验证
                        inputBox.addEventListener('input', function () {
                            // 移除可能存在的错误提示
                            const errorMsg = wrapper.querySelector('.error-message');
                            if (errorMsg) {
                                errorMsg.remove();
                            }

                            // 只允许大小写字母、数字和下划线
                            const isValid = /^[a-zA-Z0-9_]*$/.test(inputBox.value);
                            if (!isValid && inputBox.value !== '') {
                                inputBox.classList.add('error');
                            } else {
                                inputBox.classList.remove('error');

                                // 检查是否重名
                                if (inputBox.value !== '') {
                                    const existingOptions = Array.from(programSelect.options).filter(opt => opt.value !== 'new' && opt.value === inputBox.value);
                                    if (existingOptions.length > 0) {
                                        inputBox.classList.add('error');
                                    }
                                }
                            }
                        });
                    }
                });
            }

            // 创建新程序
            function createNewProgram(filename, wrapper, select) {
                // 移除可能存在的错误提示
                const errorMsg = wrapper.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }

                if (filename === '') {
                    cancelNewProgram(wrapper, select);
                    return;
                }

                // 验证文件名格式
                if (!/^[a-zA-Z0-9_]+$/.test(filename)) {
                    // 显示错误提示
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = '使用字母、数字和下划线';
                    errorMsg.style.color = '#f44336';
                    errorMsg.style.fontSize = '0.8em';
                    errorMsg.style.marginTop = '4px';
                    wrapper.appendChild(errorMsg);

                    // 重新聚焦并选中
                    inputBox.focus();
                    inputBox.select();
                    return;
                }

                // 检查是否已存在同名程序
                const existingOptions = Array.from(select.options).filter(opt => opt.value !== 'new' && opt.value === filename);
                if (existingOptions.length > 0) {
                    // 显示错误提示
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = '程序名称已存在';
                    errorMsg.style.color = '#f44336';
                    errorMsg.style.fontSize = '0.8em';
                    errorMsg.style.marginTop = '4px';
                    wrapper.appendChild(errorMsg);

                    // 重新聚焦并选中
                    inputBox.focus();
                    inputBox.select();

                    return;
                }

                // 创建新选项并添加到select中
                const option = document.createElement('option');
                option.value = filename;
                option.textContent = filename;
                select.insertBefore(option, select.lastElementChild);
                select.value = filename;

                // 清理临时元素
                wrapper.remove();
                select.style.display = 'block';

                // 清空工作区
                const workspace = Blockly.getMainWorkspace();
                workspace.clear();
            }

            // 取消创建新程序
            function cancelNewProgram(wrapper, select) {
                // 恢复原来的select
                select.style.display = 'block';

                // 移除临时元素
                wrapper.remove();

                // 恢复默认选择
                select.value = select.options[0].value;
            }

            programSelect.dispatchEvent(new Event('change'));
        });

    </script>
    <script type="text/javascript">
        function RunProgram() {
            const selectedProgram = programSelect.value;

            // 如果选择的是"新建..."，则提示用户先选择一个程序
            if (selectedProgram === 'new' || selectedProgram === '') {
                alert('请先选择一个程序');
                return;
            }

            // 创建GET请求
            const xhr = new XMLHttpRequest();
            xhr.open('GET', './api/progrun?name=' + encodeURIComponent(selectedProgram), true);

            // 设置请求完成后的回调函数
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status != 200) {
                        alert('程序运行失败: ' + (xhr.responseText || 'API操作发生未知错误'));
                    }
                }
            };
            // 先保存当前程序
            Save();
            // 发送请求
            xhr.send();
        }
    </script>
    <script type="text/javascript">
        // 页面加载完成后隐藏加载遮罩
        window.addEventListener('load', function () {
            // 确保所有资源都已加载
            setTimeout(function () {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }, 500); // 额外等待500毫秒确保所有资源加载完成
        });
    </script>

    <script>
        // 简单检测 Captive Portal WebView 的特征
        const ua = navigator.userAgent.toLowerCase();
        
        //alert(window.screen.height + "," + window.innerHeight);
        const isCaptivePortal = window.screen.height > window.screen.width && ((window.screen.height - window.innerHeight) * 5.3 > window.screen.height);

        if (isCaptivePortal) {
            document.getElementById("captiveNotice").style.display = "block";
        }
    </script>
</body>

</html>